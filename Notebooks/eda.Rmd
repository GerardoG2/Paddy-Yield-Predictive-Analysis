---
title: "newdata"
author: "Gerardo Gutierrez"
date: "2025-12-06"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load and Inspect Data
```{r}
# Load necessary libraries
library(dplyr) # data wrangling
library(tidyr) # data tidying and reshaping
library(ggplot2) # pretty plots
library(readr) 
# Load the dataset
raw_df <- read_csv("../data/agricultural_yield_train.csv")
```


```{r}
raw_df
```

```{r}
str(raw_df)
```

```{r}
colnames(raw_df)
```
[1] "Soil_Quality"                     "Seed_Variety"                     "Fertilizer_Amount_kg_per_hectare" "Sunny_Days"                      
[5] "Rainfall_mm"                      "Irrigation_Schedule"              "Yield_kg_per_hectare"            

```{r}
# Check for missing values
colSums(is.na(raw_df))
```




```{r}
# correlation heatmap for numeric var
library(reshape2)
numeric_df <- raw_df %>% select_if(is.numeric)
cor_matrix <- cor(numeric_df)
melted_cor_matrix <- melt(cor_matrix)
ggplot(data = melted_cor_matrix, aes(x=Var1, y=Var2, fill=value)) + 
  geom_tile() +
  geom_text(aes(label=round(value,2)), color="white") +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                       limit = c(-1,1), name="Correlation") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, 
                                   size = 12, hjust = 1)) +
  coord_fixed()
```
No strong correlation among covariates.


```{r}
# unique values of seed variety
unique(raw_df$Seed_Variety)

```



```{r}
# irrigation schedule unique values
unique(raw_df$Irrigation_Schedule)
```

```{r}
# histogram of all variables 
library(gridExtra)
p1 <- ggplot(raw_df, aes(x=Fertilizer_Amount_kg_per_hectare)) +
  geom_histogram(binwidth=10, fill="blue", color="black", alpha=0.7) +
  labs(title="Distribution of Fertilizer Amount", x="Fertilizer Amount (kg/ha)", y="Count") +
  theme_minimal()
p2 <- ggplot(raw_df, aes(x=Sunny_Days)) + 
  geom_histogram(binwidth=1, fill="blue", color="black", alpha=0.7) +
  labs(title="Distribution of Sunny Days", x="Sunny Days", y="Count") +
  theme_minimal()
p3 <- ggplot(raw_df, aes(x=Rainfall_mm)) +
  geom_histogram(binwidth=10, fill="blue", color="black", alpha=0.7) +
  labs(title="Distribution of Rainfall", x="Rainfall (mm)", y="Count") +
  theme_minimal()
p4 <- ggplot(raw_df, aes(x=Irrigation_Schedule)) +
  geom_histogram(binwidth=1, fill="blue", color="black", alpha=0.7) +
  labs(title="Distribution of Irrigation Schedule", x="Irrigation Schedule", y="Count") +
  theme_minimal()
p5 <- ggplot(raw_df, aes(x=Seed_Variety)) +
  geom_histogram(binwidth=1, fill="blue", color="black", alpha=0.7) +
  labs(title="Distribution of Seed Variety", x="Seed Variety", y="Count") +
  theme_minimal()
p6 <- ggplot(raw_df, aes(x=Soil_Quality)) +
  geom_histogram(binwidth=1, fill="blue", color="black", alpha=0.7) +
  labs(title="Distribution of Soil Quality", x="Soil Quality", y="Count") +
  theme_minimal()
p7 <- ggplot(raw_df, aes(x=Yield_kg_per_hectare)) +
  geom_histogram(binwidth=10, fill="blue", color="black", alpha=0.7) +
  labs(title="Distribution of Yield", x="Yield (kg/ha)", y="Count") +
  theme_minimal()
grid.arrange(p1, p2, p3, p4, p5, p6, p7, ncol=3)

```






# Model Selection

## model 1 - full model 
```{r}
# model with yiled as target
model1 <- lm(Yield_kg_per_hectare ~ Soil_Quality + Seed_Variety + Fertilizer_Amount_kg_per_hectare + Sunny_Days + Rainfall_mm + Irrigation_Schedule, data = raw_df)
summary(model1)
plot(model1)
```



```{r}
# suppress warnings
options(warn=-1)
# Durbin-Watson test for autocorrelation
library(lmtest)
dwtest(model1)

```
```{r}
# verify there is no multicollinearity with VIF
library(car)
vif(model1)
```
VIF values are all close to 1, furhter suggesting no multicollinearity.



## model 2 - without irrigation schedule
```{r}

# model without irrigation schedule
model2 <- update(model1, . ~ . - Irrigation_Schedule)
summary(model2)
plot(model2)
```
R- Squared severely dropped by about .3, - suggesting that we should keep irrigation schedule in the model.

## model 3 - without seed variety
```{r}
# model without seed variety
model3 <- update(model1, . ~ . - Seed_Variety)
summary(model3)
plot(model3)
```
Notice that the QQplot now shows severe violation of normality. Suggesting that seed variety is importatn for statistical tests. 
Additionally, the R-squared also dropped by about .5, suggesting that seed variety is important for model fit.

## model 4 - without sunny days
```{r}
# model without sunny days
model4 <- update(model1, . ~ . - Sunny_Days)
summary(model4)
plot(model4)
```
R-squared only dropped by about .02 when sunny days was removed, suggesting that sunny days may not be very important for model fit but lets conduct anova test to confirm that sunny days is not significant. 
```{r}
# compare reduced model with full model using ANOVA to see if sunny days is significant
anova(model1, model4)
```
$H_0:$ Sunny days does not significantly improve the model fit.
We REJECT $H_0$ since p-value is less than 0.05, suggesting that sunny days is significant and should be kept in the model.

## model 5 - without fertilizer amount
```{r}
# model without fertilizer amount
model5 <- update(model1, . ~ . - Fertilizer_Amount_kg_per_hectare)
summary(model5)
plot(model5)
```
```{r}
# compare reduced model with full model using ANOVA to see if fertilizer amount is significant
anova(model1, model5)
```
Ferlizer helpls variability significantly.
R-squared dropped by about .1 when fertilizer amount was removed.

Additionally, in the anova test we reject $H_0:$ fertilizer amount does not significantly improve the model. So we keep fertilizer in the model.

## model 6 - without rainfall
```{r}
# model without rainfall
model6 <- update(model1, . ~ . - Rainfall_mm)
summary(model6)
plot(model6)
```
```{r}
# compare reduced model with full model using ANOVA to see if rainfall is significant
anova(model1, model6)
```
We keep rainfall since it helps explain variabality and is significant in the anova F test.



```{r}
# compare models using AIC
AIC(model1, model2, model3, model4, model5, model6)

```
In conclusion, we keep the full model (model 1) as it has the lowest AIC, highest adjusted R-squared, and all variables are significant based on anova tests.

# Inference and Interpretations
**Interpretation of beta coefficients:**

```{r}
summary(model1)$coefficients
```

- Holding all other covariates constant, we can expect an average increase in yield of about 1.54 kg/ha for each additional unit increase in soil quality.
- Switching to a high yield seed variety (from 0 to 1), we can expect an average increase in yield of about 300.46 kg/ha, holding all other variables constant.
- For each additional kg/ha of fertilizer applied, we can expect an average increase in yield of about 0.81 kg/ha, holding all other variables constant.
- For each additional sunny day, we can expect an average increase in yield of about 1.99 kg/ha, holding all other variables constant.
- For each additional mm of rainfall, we can expect an average decrease in yield of about 0.51 kg/ha, holding all other variables constant.
- For each addition in irrigation count, we can expect an average increase in yield of about 49.99 kg/ha, holding all other variables constant.

## check for outliers, influential, and leverage points


```{r}
# Leverage points
n = nobs(model1)
p = length(coef(model1))

leverages <- hatvalues(model1)
model1$fitted.values[leverages > (3 * p/n)]
```

```{r}
# Outliers
standardized_residuals <- rstandard(model1)
studentized_residuals <- rstudent(model1)

model1$fitted.values[abs(studentized_residuals) > 3]
model1$fitted.values[abs(standardized_residuals) > 3]
```
```{r}
# influential
cook_distances <- cooks.distance(model1)
model1$fitted.values[cook_distances > 1]
```
```{r}
# dffits
n = nobs(model1)
p = length(coef(model1))

dffits_values <- dffits(model1)
model1$fitted.values[abs(dffits_values) > (2 * sqrt(p/n))]
```
```{r}
# Dfbetas
n = nobs(model1)
p = length(coef(model1))

dfbetas_values <- data.frame(dfbetas(model1))
abs(dfbetas_values) > (2 / sqrt(n))
```
```{r}
# Get rows with more than where there is at least 5 high dfbetas
influential_rows <- which(rowSums(abs(dfbetas_values) > (2 / sqrt(n))) >= 1)
influential_rows
```
```{r}
# size of influential_rows
length(influential_rows)

# build model without influential observations
df_no_influential <- raw_df[-influential_rows, ]
model_no_influential <- lm(Yield_kg_per_hectare ~ ., data = df_no_influential)
summary(model_no_influential)

# compare coefficients
model1$coefficients
model_no_influential$coefficients
```
After removing regression coefficients are not being heavily influenced by the points with high dfbetas.

```{r}
# 
confint(model1, level = 0.95)
```

**Interpretation of confidence intervals for beta coefficients:**
- We are 95% confident that, holding all other variables constant, each unit increase in soil quality will result in between 1.49 and 1.60 kg/ha of additional yield.
- We are 95% confident that switching to a high yield seed variety will result in between 298.77 and 302.16 kg/ha of additional yield, holding all other variables constant.
- We are 95% confident that for each additional kg/ha of fertilizer applied, the yield will increase by between 0.80 and 0.82 kg/ha, holding all other variables constant.
- We are 95% confident that for each additional sunny day, the yield will increase by between 1.91 and 2.07 kg/ha, holding all other variables constant.
- We are 95% confident that for each additional mm of rainfall, the yield will decrease by between 0.51 and 0.50 kg/ha, holding all other variables constant.
- We are 95% confident that for each additional irrigation count, the yield will increase by between 49.64 and 50.33 kg/ha, holding all other variables constant.




# Prediction Intervals and Confidence Interval
```{r}
# preidction interval for new data
new_farm <- data.frame(
  Soil_Quality = 80,
  Seed_Variety = 1,
  Fertilizer_Amount_kg_per_hectare = 200,
  Sunny_Days = 100,
  Rainfall_mm = 500,
  Irrigation_Schedule = 8
)

predict(model1, newdata = new_farm, interval = "prediction")

```


```{r}
# confidence intervals for mean prediction
predict(model1, newdata = new_farm, interval = "confidence")

```

```{r}
# visualize prediction and confidence intervals
library(ggplot2)
predictions <- predict(model1, interval = "prediction")
conf_intervals <- predict(model1, interval = "confidence")
pred_df <- data.frame(
  Fitted = model1$fitted.values,
  Lower_Pred = predictions[, "lwr"],
  Upper_Pred = predictions[, "upr"],
  Lower_Conf = conf_intervals[, "lwr"],
  Upper_Conf = conf_intervals[, "upr"],
  Actual = raw_df$Yield_kg_per_hectare
)
ggplot(pred_df, aes(x=Fitted, y=Actual)) +
  geom_point(color="blue", alpha=0.6) +
  geom_ribbon(aes(ymin=Lower_Pred, ymax=Upper_Pred), fill="red", alpha=0.2) +
  geom_ribbon(aes(ymin=Lower_Conf, ymax=Upper_Conf), fill="green", alpha=0.2) +
  labs(title="Prediction and Confidence Intervals", x="Fitted Values", y="Actual Yield") +
  theme_minimal()


```

The prediction band shows that most of the true yields fall within the 95% prediction interval for new observations and that the model predicts new data well.

```{r}
# Load test dataset
test_df <- read_csv("../data/agricultural_yield_test.csv")
```


```{r}

```


